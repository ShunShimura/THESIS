\thispagestyle{fancy2}

\section{AIシステムの役割}
個性付き一細胞分取システムは，プロトプラスト化した細胞を一つずつ収集し，かつそれら細胞すべてについてプロトプラスト化する以前の根における領域を特定すること
% （図\ref{fig:system}参照）
を目的とし，AI・ロボットによるそれらの完全自動化を目指していた．また自動化においては，一定時間内で収集できる細胞数を増やしたり，収集の失敗をなるべく削減したりなど，効率性及び正確性も求められる．

% \begin{figure}[t]
%     \centering
%     \includegraphics[width=.3\textwidth]{fig/nagoya-u.eps}
%     \caption{個性付き一細胞分取システムの目的}
%     \label{fig:system}
% \end{figure}

\par
本システムの主な要素は，リアルタイムでプロトプラスト化の様子を撮影する顕微鏡，プロトプラスト化した細胞の収集を行うロボット，その他目的を達成するためのAIの３つである．このAIが求められているタスクは以下の２つである．

\begin{enumerate}[label=(\arabic*)]
    \item ロボットが向かうべき位置を示すこと．
    \item 取得した細胞のプロトプラスト化以前の領域を特定すること．
\end{enumerate}

これらのタスクを達成するために，AIシステムではリアルタイム細胞追跡を行う．より具体的には，顕微鏡から得られた画像をリアルタイムで処理し，各細胞の位置を認識，さらに各細胞にIDを割り振ることで追跡を行う．まず(1)のタスクについては，追跡している各細胞の最新の位置か若しくは追跡した軌跡から推定した予測位置を出力し，何らかの方策最適化で取りに行く細胞を一つ選べば良い．この方策最適化については本論文の範囲外のため割愛させていただく．(2)のタスクについては，追跡してきた軌跡を逆向きに辿れば達成できる．
\par
以降の節では，AIシステムの入力及び出力について詳細に述べる．

    \subsection{共焦点顕微鏡から得られる4Dデータ}
    本システムでは，植物の根及びプロトプラスト化した細胞は酵素溶液中，すなわち流体環境にさらされているため，３次元空間を遊離する．そのため細胞の追跡を行うためには，３次元空間を認識する顕微鏡を使用しなければならない．
    \par
    共焦点顕微鏡は，このような問題に対処することができる．共焦点顕微鏡とは，焦点と共役する位置にピンホールを置くことで焦点外で発生した光を排除し，対象物体の光学断面像（以降スライスと呼ぶ）を得ることができる顕微鏡である（図\ref{fig:confocal}参照）．焦点距離は可変であるため，スライスの高さを変えながら撮影することができる．すなわち３次元空間を，複数の高さでスライスした２次元画像の集合，という形式で捉えることが可能である．本システムでは，この焦点面の高さを変えながら２次元スライス画像を取得しつつ，時間方向にこれを繰り返すことで，空間３次元＋時間の４次元データを取得する．ただしここでは，焦点面の高さが連続する２枚の画像間でも有限の時間差が生じることに注意されたい．

    \begin{figure}[t]
        \centering
        \includegraphics[width=\textwidth]{fig/confocal.pdf}
        \caption{共焦点顕微鏡の概略図}
        \small
        左の図では緑色の光が焦点で集まり，うまく検出されている．これにより，緑色の光が集まっている点の高さの像を捉えられる．一方右の図の赤色の光が集まっている点の高さでは，光は検出器手前のピンホールに遮られ，排除される．
        \label{fig:confocal}
    \end{figure}

    \subsection{遊離した細胞の位置予測}
    プロトプラスト化して遊離した細胞が，ほとんど運動をしていないか静止している場合には，最新の画像から得られた位置にロボットを向かわせれば十分に取得できる．しかしながら当然遊離した細胞は速度を持ち，それに加えてロボットを動かすことによる流体外乱によってその速度は影響を受ける．また前述のとおり，画像は細胞の運動に関係なく撮影されるため，最新の画像から得られた位置に向かわせるだけでは不十分である．
    \par
    そこで本システムでは，AIによる細胞の位置予測を行う．より具体的には，一定時間後の予測位置のみを出力するのではなく，速度や加速度も加えて予測する．これにより，ロボットがある細胞の位置へ到着するまでにかかる時間やその経路も考慮に入れて細胞を収集することができる．

    \subsection{遊離前領域との対応付け}
    遊離する前の領域を特定するためには，図\ref{fig:segmentation}に示すようなセグメンテーションという処理が適している．そのためすべての時刻に対してセグメンテーションを実施し，細胞追跡を行うのが直感的な手法である．
    しかしながら一般的に，セグメンテーションの推論時間には数分以上を要してしまうため，リアルタイムな処理に適していない．
    \par
    そこで本システムでは，遊離前の領域特定はオフラインなセグメンテーションを行い，遊離直後からの細胞追跡はオンラインな物体検出を行う．そしてオフライン処理時に，図\ref{fig:segmentation_matching}のように遊離直後の位置情報と遊離前のセグメンテーションのID対応付けを行う．
    \par
    よって細胞追跡では，遊離する前の細胞は位置認識せず，プロトプラスト化して遊離している細胞のみを追跡対象とする．対応付けの手法については本論文の範囲外のため，割愛させていただく．

    \begin{figure}[t]
        \centering
        \begin{subfigure}[b]{.4\textwidth}
            \centering
            \includegraphics[width=\textwidth]{fig/segmentation.pdf}
            \caption{セグメンテーションの例}
            \label{fig:segmentation}
        \end{subfigure}
        \hspace{30pt}
        \begin{subfigure}[b]{.4\textwidth}
            \centering
            \includegraphics[width=\textwidth]{fig/segmentation_matching.pdf}
            \caption{遊離直後位置とのマッチング}
            \label{fig:segmentation_matching}
        \end{subfigure}
        \small \\
        (a)厳密にはインスタンスセグメンテーションと呼ばれる，個々の物体ごとに領域を検出する処理である．この例では車のみを対象としている．(b)セグメンテーションの結果と追跡によって得た遊離直後の位置のマッチング．図では橙色と水色の細胞がそれぞれ同一細胞である．
    \end{figure}

\section{問題設定の一般化及び定式化}

この章では，これまでに議論した問題設定を一般化しながら定式化を行う．
\par
まずは，遊離した細胞の定式化を行う．植物の根からプロトプラスト化し，酵素溶液中に遊離した細胞は，図\ref{fig:protoplast}にあるように球体としてみなせる．この球体の位置や大きさを表す変数として，状態変数ベクトル$\bm{s}(t) \in \mathbb{R}^n$を定義する．ここで$n$はその特徴量の個数であり，$t$は連続的な時刻である．前述のとおり，遊離した細胞は流体環境にさらされている．そのため，外乱に依存する加速度まで状態変数に加えるべきであるが，実際に取得したデータからあまり大きな外力に起因する挙動が見られなかったため，状態変数ベクトル$\bm{s}(t)$は，式\ref{eq:state_vector}とする．

\begin{equation}
    \label{eq:state_vector}
    \bm{s}(t) \equiv \left[x(t), \dot{x}(t), y(t), \dot{y}(t), z(t), \dot{z}(t), r(t)\right]^{\top}
\end{equation}
ここで，$\dot{A}(t)$は一階時間微分$dA/dt$を表す．また，$r(t)$は球体の半径である．また細胞は同時刻に複数個存在するため，ある時刻$t$において存在する各細胞の状態変数集合$S(t)$を，

\begin{equation}
    S(t) \equiv \left\{\left.\bm{s}^{(i)}(t)\right| i \in \mathbb{N}_{\geq 0}\right\}
\end{equation}
と表す．ここで$i$は遊離した細胞を識別するためのIDを示している．
ここまでは連続的な時間で状態変数を考えてきたが，一般に計算機で何かしらの処理を行う際は離散化が必要である．そのため，離散的な状態変数ベクトル$\bm{s}_t$と状態変数集合$S_t$を新たに式\ref{eq:discreation}で定義する．

\begin{equation}
    \label{eq:discreation}
    \begin{aligned}
        \bm{s}_t &\equiv \left[x_t, \dot{x}_t, y_t, \dot{y}_t, z_t, \dot{z}_t, r_t\right]
        \\ S_t &\equiv \left\{\left.\bm{s}^{(i)}_t\right| i \in \mathbb{N}_{\geq 0}\right\}
    \end{aligned}
\end{equation}
また流体外乱や細胞同士の相互作用の効果として，加速度を正規ホワイトノイズとして加算する．よって時間遷移は式\ref{eq:time_transition}で表せられる．ただしここでは冗長性のため$x$のみの遷移を記述した．

\begin{equation}
    \label{eq:time_transition}
    \begin{aligned}
        x_{t+1} &= x_t + \dot{x}_t dt + \frac{1}{2} a_x dt^2
        \\ \dot{x}_{t+1} &= \dot{x}_t + a_x dt
        \\ a_x & \sim \mathcal{N}(0, A_x)
    \end{aligned}
\end{equation}
ここで$dt$は有限な時間変位，$a_x$は正規ホワイトノイズ，$A_x$はその分散である．また半径$r_t$は定常なものとする．
\par
次に，共焦点顕微鏡から得られる複数のスライス画像の定式化を行う．共焦点顕微鏡は，焦点面を調整することで複数の高さにおけるスライス画像を得ることができる顕微鏡であった．この特性を用いて，本システムでは焦点面を変えながら図\ref{fig:slicing}のように複数の高さにおけるスライス画像を取得する．このスライスの枚数を$n_s$と定義する．この$n_s$枚のスライス画像取得を一時刻分の入力データとすると，ある時刻$t$における入力データ$\mathcal{X}_t$は，

\begin{equation}
    \label{eq:input_images}
    \begin{aligned}
        \mathcal{X}_t &\equiv \left\{ \left.X^{(t,s)}\right| s \in \left\{1,2,\dots,n_s\right\} \right\}
        \\ X^{t,s} &\in \mathbb{R}^{W \times H \times 3}
    \end{aligned}
\end{equation}
と表せられる．ここで$s$はスライスの高さと対応づいている．本論文では，$s=1$が３次元空間内で最も$z$が小さい点に対応しているとする．また$W$は取得画像のピクセル幅，$H$はピクセル高さ，$3$はRGBに対応している．

\begin{figure}[t]
    \centering
    \includegraphics[width=\textwidth]{fig/slicing.pdf}
    \caption{得られる共焦点画像のイメージ}
    \small
    $n_s=10$の例を示している．また最下部が$s=1$とされていることに注意されたい．
    \label{fig:slicing}
\end{figure}

\par
最後に，AIシステムが出力する細胞の予測及び遊離直後の予測の定式化を行うが，便宜上のために追跡しているトラックの定式化を先に行う．時刻$t$において追跡している情報の集合$\mathcal{T}_t$を，

\begin{equation}
    \begin{aligned}
        \mathcal{T}_t &\equiv \left\{ \left. T_t^{(i)}\right|i \in \mathcal{I}_t\right\}
        \\ T_t^{(i)} &\equiv \left\{ \hat{\bm{s}}_t \left|\ t \in \left\{t_s^{(i)}, t_s^{(i)}+1,\dots, t\right\} \right.\right\}
        \\\hat{\bm{s}}_{t} &\equiv \left[\hat{x}_{t}, \hat{\dot{x}}_{t}, \hat{y}_{t}, \hat{\dot{y}}_{t}, \hat{z}_{t}, \hat{\dot{z}}_{t}, \hat{r_{t}}\right]
    \end{aligned}
\end{equation}
と定義しておく．ここで$\mathcal{I}_t$は時刻$t$において追跡している細胞のID集合，$t_s^{(i)}$は，細胞$i$が遊離した直後の時刻，$\hat{A}$は$A$の推定値を表す．

節2.1.2で議論したように，細胞の予測では位置に加えて速度や加速度の予測も行うことが望ましい．しかしながら本節での一般化で，加速度が正規ホワイトノイズであることを仮定した．よって本論文では，位置，速度そして半径の予測を行う．すなわち時刻$t$における予測$S^{\text{pred}}_t$は，

\begin{equation}
    \label{eq:output1}
    \begin{aligned}
        S^{\text{pred}}_t &\equiv \left\{ \left. \hat{\bm{s}}_t^{(i)}\right| i \in \mathcal{I}_t\right\}
    \end{aligned}
\end{equation}
と表す．これはすなわち，式\ref{eq:discreation}で示した細胞の状態変数を推定することと等価である．またここでの細胞IDである$i$は式\ref{eq:discreation}に一致する必要がなく，識別が可能であれば十分であることに注意されたい．
\par
また遊離直後の位置に関しても，冗長である可能性ももちろんあるが，位置だけでなく大きさを示す半径や，プロトプラスト化した際の方向に関連する速度は有益な情報になる．そのため予測同様，状態変数ベクトルの集合を出力させる．ただし，ここで出力するのは時刻$t$の状態変数ではなく，各細胞が遊離した直後の時刻$t_s^{(i)}$であることに注意されたい．すなわち時刻$t$における各細胞の遊離直後位置の情報$S^{\text{init}}_t$は，

\begin{equation}
    \label{eq:output2}
    \begin{aligned}
        S^{\text{init}}_t &\equiv \left\{ \left. \hat{\bm{s}}_{t_s^{(i)}}^{(i)}\right| i \in \mathcal{I}_t\right\}
    \end{aligned}
\end{equation}
で表される．

\par
本システムではロボットが細胞の挙動に合わせてリアルタイムで収集を行うため，式\ref{eq:output1}--\ref{eq:output2}の出力もリアルタイムで行わなければならない．したがって本システムは時刻$t$の入力$\mathcal{X}_t$が得られたら$S_t^{\text{pred}}$及び$S_t^{\text{init}}$を出力するオンライン処理を実施する．ただし，時刻$t$の処理にはそれまでの入力データ$\mathcal{X}_1, \dots, \mathcal{X}_{t-1}$及びそれらから計算されたものも利用できることに注意されたい．

\section{AIシステムの課題点}
ここでは議論を容易にするため，複数のスライス画像を撮影し続けた時に，ある単一スライスにおけるフレーム間隔を$dt$，一秒間あたりのフレーム数をフレームレートと呼ぶことにする．また撮影を行う３次元空間の高さの範囲を$Z$とした時に，スライス間隔を$dz \equiv Z / n_s$と定義する．
\par
本章で述べた問題設定では，これらの間隔$dt$及び$dz$を無限に小さくすれば容易に目的を達成することができる．なぜならば，$dt$を無限小にすれば時間的な変位はほとんどなく，単に近いものを対応付けてゆけば追跡が可能である．また$dz$を無限小にすればどれだけ小さい細胞でも正確に中心位置や半径を推定できる．
\par
しかしながら実際には，共焦点顕微鏡で画像一枚を取得するのに無視できない時間を要する．具体的には，一枚あたり一秒ほどかかる．これにより，同時に$dt$と$dz$を無限に小さくすることは不可能になる．例えば，プロトプラスト化した細胞の大きさ$10$個分の高さの範囲を対象空間を仮定すると，少なくともスライス数$n_s$は$10$以上に設定するのが妥当である．この場合一時刻分の画像取得には$10$秒ほど要してしまう．すなわち$dt \geq 10$となり，フレームレートがかなり落ちてしまう．当然ながらここからフレームレートを上げる場合には，スライス数を減らさなければならず，そうすると連続するスライスの間に入り込んだ細胞を検出することはできなくなってしまう．
\par
以上の議論より，本システムでは時間間隔とスライス間隔のトレードオフが課題点である．よって後述の提案手法では，特にこのトレードオフに着目することとする．またオンライン処理を行わなければならないため，AIシステムの処理時間がリアルタイム性を持つことも制約として加えられる．