\thispagestyle{fancy2}
この章では，個性付き１細胞取得システムを達成するためのAIシステムの概要説明，およびAIが解くタスクの定式化を行う．

\section{AIシステムの概要}
上述の通り，本プロジェクトでは細胞の個性として遊離前の細胞の位置情報を設定している．その位置情報を保持するために，AIを用いてリアルタイム細胞追跡を行う．これにより得られる効果は以下の２つである．
\begin{itemize}
    \item 各細胞の現在の位置，及び一定時間後の位置を予測することができる．
    \item 各細胞に対して，遊離する前のそれぞれの位置を保持することができる．
\end{itemize}
また，AIに入力するデータは，共焦点顕微鏡から得られる画像データである．ここで共焦点顕微鏡とは，焦点と共役する位置にピンホールを置くことで焦点外で発生した光を排除し，対象物体の光学断面像（以降スライスと呼ぶ）を得ることができる顕微鏡である（図\ref{fig:confocal-microscope}参照）．
\par
本タスクはリアルタイム細胞追跡を行うため，時刻$t$の画像データが入るたびに処理を行うオンライン処理であることに注意されたい．このとき，時間方向のフレーム長さ$n_f$と時間間隔$dt$はハイパーパラメータである．
\par
以降では，時刻$t$におけるAIシステムの入力，出力について詳細を述べたあと，タスクを一般化し，本プロジェクトに適用するための課題点を説明する．

\section{共焦点顕微鏡から得られる画像データ}
前述の通り共焦点顕微鏡とは，焦点外で発生した光を排除し，対象物体のスライス像を得ることができる顕微鏡である．例えば図\ref{fig:confocal-microscope}では，サンプル上で緑色の光路が反射している高さのスライス像を取得する際の光路の一例を示している．右図に示すように，赤色の光路が反射している高さの光は，ピンホール１より手前で集光するために検出器に入る前に除去される．

\begin{figure}[h]
    \includegraphics[width=\linewidth]{fig/fig1.pdf}
    \centering
    \caption{共焦点顕微鏡の概略図}
    \small 
    左の図では，緑色の光路が反射しているサンプルの高さであれば光を集光できている．一方右の図では，高さが合わず集光ができていない，言い換えれば赤い色の光路が反射している高さの情報を除去できていることが分かる．
    \label{fig:confocal-microscope}
\end{figure}

そして水平方向に走査させることで，ある高さにおける２次元画像を取得することができる．また，この高さを動的に変更することができることが共焦点顕微鏡の強みである．これにより，サンプルの３次元情報を，複数のスライスという形で捉えることが可能となる．このとき，スライスの枚数$n_s$とその間隔$dz$はハイパーパラメータである．
\par
以上の説明により，時刻$t$におけるAIシステムの入力は$n_s$枚の２次元画像データである．ただし，各スライスが取得された時刻が異なることに注意されたい．ここで，ある時刻$t$におけるある高さ$z$のスライス$s_{t,z} \in \mathcal{S}$を入力して取得された時刻$t_{t,z} \in \mathcal{T}$を出力する写像$f:\mathcal{S} \rightarrow \mathcal{T}$を考える．このとき$f$は，

\begin{equation}
    f(s_{t,z}) = t + \frac{s}{n_s} dt
    \label{slice-time}
\end{equation}

と表せられる．ここで$n_s$はスライス数，$dt$は時間間隔である．

\section{細胞の位置予測と遊離前位置の特定}
次に，AIシステムの出力データについて述べる．時刻$t$における出力データは，以下の２つである．
\begin{itemize}
    \item 時刻$t+1$の各細胞に対する予測位置$\left[x, y, z, r\right]$
    \item 各細胞に対する，遊離直後の推定位置$\left[x, y, z, r\right]$
\end{itemize}
ここで，$\left(x,y,z\right)$は細胞を球とみなしたときの中心位置，$r$は半径である．以降ではそれぞれについて詳細に述べる．
\subsection{時刻$t+1$の予測}
本プロジェクトでは，マイクロロボットツールを用いて細胞の収集を行う．しかしながら手動で操作する場合では，非常に効率が悪くなる．理由としては主に２つある．１つ目は，微調整に時間がかかるためである．水平方向へはもちろんのことだが，特に鉛直方向の調整は容易には行えない．なぜならば，マイクロロボットツールの先端は共焦点顕微鏡には映らず，スライスではない通常の明視野顕微鏡で位置合わせを行わなければならないためである．そのため，対象の細胞がどの高さにあるかを特定できず，トライアンドエラーで高さを調整しなければならない．２つ目は，収集経路に無駄が生じてしまうためである．本プロジェクトの目的は遺伝子発現パターンと再生力の関係を探ることであるため，サンプル数はできる限り多いほうがよい．そのため，工夫をせずに収集を行うと，多大な時間を要してしまう．
\par
よってAIシステムでは，各細胞の時刻$t+1$の位置及び速度を予測し，それらの情報をもとにロボットへの指示をAIシステムによって行う．本研究の範囲外ではあるが，これらの情報を用いることで最適経路の計算が可能になる．
\par
以上より，時刻$t$における時刻$t+1$の予測位置の出力は，式\eqref{output1}のように表せられる．

\begin{equation}
    \label{output1}
    \begin{aligned}
        S_t &= \left\{\hat{\bm{s}}_1^{(t+1)}, \hat{\bm{s}}_2^{(t+1)}, ..., \hat{\bm{s}}_n^{(t+1)}\right\}
        \\ \hat{\bm{s}}_i^{(t+1)} &= \left[x, \dot{x}, y, \dot{y}, z, \dot{z}, r\right] \hspace{10pt} i = 1,2,...,n
    \end{aligned}
\end{equation}

ここで，$n$は時刻$t$で追跡している細胞の個数，$\hat{\bm{s}}_i^{(t+1)}$は，各細胞$i$の時刻$t+1$の予測位置，$(x,y,z)$は細胞を球とみなしたときの中心位置，$(\dot{x},\dot{y}, \dot{z})$は中心位置の速度，$r$は半径である．

\subsection{遊離直後の位置推定}
本プロジェクトのシステムでは，細胞の遊離前位置の保持を目的としていた．しかしAIシステムでは，遊離前の位置ではなく，遊離直後の位置の保持を行う．なぜならば，遊離前の位置特定の3Dセグメンテーション処理に時間がかかるためである．ここでセグメンテーションとは，画像１ピクセルに対してラベルを割り当てる処理のことをいう．反対に，遊離したあとの細胞を追跡するには，セグメンテーションを行う必要はなく，後述の物体検出処理で十分である．また，物体検出処理であれば高速で行うことができる．そのためAIシステムでは，遊離直後の位置から追跡を開始し，事後に3Dセグメンテーションと追跡処理の対応付けを行う．
\par
時刻$t$における各細胞の遊離直後位置の出力は，2.3.1と同様に以下のように表せられる．

\begin{equation}
    \label{output1}
    \begin{aligned}
        S_t^{\textrm{init}} &= \left\{\hat{\bm{s}}_1^{\textrm{init}}, \hat{\bm{s}}_2^{\textrm{init}}, ..., \hat{\bm{s}}_n^{\textrm{init}}\right\}
        \\ \hat{\bm{s}}_i^{\textrm{init}} &= \left[x, \dot{x}, y, \dot{y}, z, \dot{z}, r\right] \hspace{10pt} i = 1,2,...,n
    \end{aligned}
\end{equation}

ここで，$n$は時刻$t$で追跡している細胞の個数，$\hat{\bm{s}}_i^{\textrm{init}}$は，各細胞$i$の追跡が開始した時刻における推定位置，$(x,y,z)$は細胞を球とみなしたときの中心位置，$(\dot{x},\dot{y}, \dot{z})$は中心位置の速度，$r$は半径である．

\section{問題設定の一般化と課題点}
この節では，前述の問題設定を一般化したのち，本プロジェクトに応用するうえで考慮しなければならない課題点について述べる．

\subsection{問題設定の一般化}
ここまでの問題設定を以下にまとめる．
\begin{description}
    \item[処理] 時刻$t$で制御されるオンライン処理．ただし時間間隔$dt$はハイパーパラメータ．
    \item[入力] 各時刻$t$において，$n_s$枚の画像系列データ．各画像は，共焦点顕微鏡の焦点が共役となる高さと対応している．ただし画像が得られる時刻には時間差があることに注意．
    \item[出力] 時刻$t$で追跡している$n$個の細胞の，時刻$t+1$の予測位置・速度$S_t \in \mathbb{R}^{n \times 7}$と遊離直後の位置・速度$S_t^{\textrm{init}} \in \mathbb{R}^{n \times 7}$．
\end{description}
\par
本プロジェクトでは細胞を対象としているが，以降の章では中心座標と半径で表せられる仮想的な球体を対象として本問題を考える．また問題の簡易化のため，細胞同士の相互作用（衝突や流体を媒体とした流れ）は考慮しない．

\subsection{時間間隔とスライス間隔のトレードオフ}
共焦点顕微鏡は，焦点距離を調整することでスライスの高さを調整し，空間３次元＋時間の４次元のデータを取得することができた．しかしながら，共焦点顕微鏡による画像の取得には，無視できない時間がかかる．例えば本プロジェクトでは，画像の解像度が$2048 \times 2048$であるが，この場合一枚あたり一秒程時間を要してしまう．これにより，追跡を簡単にするため同じ高さのスライスの時間間隔（以降これをフレームレートと呼ぶ）を短くしようとすれば，スライス数$n_s$を減らす必要が出てしまう．常に同じ空間範囲に適用する場合はスライス間隔が大きくなり，対象物体の大きさによっては見逃しが生じることとなる．反対に，スライス数$n_s$を大きくして空間を密に捉える場合は，一時刻分の画像取得に時間がかかってしまい，フレームレートが落ちてしまう．この場合は，大きく移動している細胞の追跡が困難になり，特に時刻$t+1$の位置予測の精度を上げることも困難になる．すなわち，リアルタイム性が損なわれてしまう．
\par
以上の議論より本研究では，時間方向・空間方向に分解能のトレードオフが存在する場合に，ロバストに追跡を行うことができる手法を目指す．
